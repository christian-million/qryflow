# qryflow

## Overview

Execute multi-step ‘SQL’ statements using specially formatted comments
that define and control execution.

`qryflow` lets you define **multi-step SQL workflows** using
comment-based tags in your SQL code. These tags tell R how to execute
each SQL chunk and what to name the results. This allows you to:

- Keep multiple SQL statements in the same file.

- Control how each SQL “chunk” is executed.

- Return results as named R objects.

- Extend behavior using custom tags, parsers, and handlers.

## Install

You can install the released version of `qryflow` from
[CRAN](https://cran.r-project.org/) with:

``` r
install.packages("qryflow")
```

And the development version from GitHub with:

``` r
# install.packages("devtools")
devtools::install_github("christian-million/qryflow")
```

## Example

The code below demonstrates the primary use case for `qryflow`.

Basic Usage:

``` r
library(qryflow)

# Connection to In-Memory DB with table populated from mtcars
con <- example_db_connect(mtcars)

sql <- "
-- @exec: drop_cyl_6
DROP TABLE IF EXISTS cyl_6;

-- @exec: prep_cyl_6
CREATE TABLE cyl_6 AS
SELECT *
FROM mtcars
WHERE cyl = 6;

-- @query: df_mtcars
SELECT *
FROM mtcars;

-- @query: df_cyl_6
SELECT *
FROM cyl_6;
"

# Pass tagged SQL to `qryflow`
results <- qryflow(con, sql)

# Access the results from the chunk named `df_cyl_6`
head(results$df_cyl_6)
#>    mpg cyl  disp  hp drat    wt  qsec vs am gear carb
#> 1 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
#> 2 21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
#> 3 21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1
#> 4 18.1   6 225.0 105 2.76 3.460 20.22  1  0    3    1
#> 5 19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
#> 6 17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4
```

The path to a file containing SQL can also be passed:

``` r
filepath <- example_sql_path('mtcars.sql')

# Pass tagged SQL to `qryflow`
results <- qryflow(con, filepath)

# Access the results from the chunk named `df_cyl_6`
results$df_cyl_6 |>
  head()
#>    mpg cyl  disp  hp drat    wt  qsec vs am gear carb
#> 1 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
#> 2 21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
#> 3 21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1
#> 4 18.1   6 225.0 105 2.76 3.460 20.22  1  0    3    1
#> 5 19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
#> 6 17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4
```

## Additional Learning

Consider the following vignettes for a more in depth understanding:

- Getting Started: Outlines available features, how to use `qryflow`,
  and provides an operational understanding of how it works
  (`vignette("getting-started", package = "qryflow")`).

- Advanced Usage: A look under the hood at the objects and classes that
  power `qryflow` so that you can get more out of the package
  ([`vignette("advanced-qryflow", package = "qryflow")`](https://christian-million.github.io/qryflow/articles/advanced-qryflow.md)).

- Extend `qryflow`: A guide to understanding how to implement custom
  tags, or override the built-in tags, using custom chunk parsers and
  handlers
  ([`vignette("extend-qryflow", package = "qryflow")`](https://christian-million.github.io/qryflow/articles/extend-qryflow.md)).

## Similar Packages

The functionality made available by `qryflow` exists in other packages.
However, the scope and implementation of `qryflow` makes it distinct
enough to justify a unique package.

I recommend reviewing these other packages to see which works best for
your needs. If you feel this list is incomplete, please submit an issue:

- [`sqlhelper`](https://CRAN.R-project.org/package=sqlhelper) provides
  comprehensive tools for executing parameterized SQL scripts, managing
  database connections and configurations, supporting spatial data
  types, and statement-level control within SQL files.

- [`SQLove`](https://cran.r-project.org/package=SQLove) is ‘a
  lightweight R package for handling complex SQL scripts including temp
  tables, multiple queries, etc.’

# Package index

## Running and Managing ‘SQL’ Workflows

Functions for executing multi-step SQL workflows with tagged SQL
scripts. These tools let you parse SQL into chunks, control execution,
and retrieve structured results.

- [`qryflow()`](https://christian-million.github.io/qryflow/reference/qryflow.md)
  : Run a multi-step SQL workflow and return query results

- [`qryflow_run()`](https://christian-million.github.io/qryflow/reference/qryflow_run.md)
  : Parse and execute a tagged SQL workflow

- [`qryflow_results()`](https://christian-million.github.io/qryflow/reference/qryflow_results.md)
  :

  Extract results from a `qryflow_workflow` object

- [`qryflow_parse()`](https://christian-million.github.io/qryflow/reference/qryflow_parse.md)
  : Parse a SQL workflow into tagged chunks

- [`qryflow_execute()`](https://christian-million.github.io/qryflow/reference/qryflow_execute.md)
  : Execute a parsed qryflow SQL workflow

## Registration

Functions that allow users to register custom types and inspect the
registry. These are useful for extending qryflow.

- [`register_qryflow_type()`](https://christian-million.github.io/qryflow/reference/register_qryflow_type.md)
  [`register_qryflow_parser()`](https://christian-million.github.io/qryflow/reference/register_qryflow_type.md)
  [`register_qryflow_handler()`](https://christian-million.github.io/qryflow/reference/register_qryflow_type.md)
  : Register custom chunk types
- [`qryflow_parser_exists()`](https://christian-million.github.io/qryflow/reference/qryflow_parser_exists.md)
  : Check existence of a given parser in the registry
- [`qryflow_handler_exists()`](https://christian-million.github.io/qryflow/reference/qryflow_handler_exists.md)
  : Check existence of a given handler in the registry
- [`ls_qryflow_handlers()`](https://christian-million.github.io/qryflow/reference/ls_qryflow_types.md)
  [`ls_qryflow_parsers()`](https://christian-million.github.io/qryflow/reference/ls_qryflow_types.md)
  [`ls_qryflow_types()`](https://christian-million.github.io/qryflow/reference/ls_qryflow_types.md)
  : List currently registered chunk types
- [`validate_qryflow_parser()`](https://christian-million.github.io/qryflow/reference/validate_qryflow_parser.md)
  : Ensure correct parser structure
- [`validate_qryflow_handler()`](https://christian-million.github.io/qryflow/reference/validate_qryflow_handler.md)
  : Ensure correct handler structure

## Helpers for Extending qryflow

These functions are exported to help users extend qryflow with custom
parsers and handlers.

- [`read_sql_lines()`](https://christian-million.github.io/qryflow/reference/read_sql_lines.md)
  : Standardizes lines read from string, character vector, or file

- [`collapse_sql_lines()`](https://christian-million.github.io/qryflow/reference/collapse_sql_lines.md)
  : Collapse SQL lines into single character

- [`is_tag_line()`](https://christian-million.github.io/qryflow/reference/is_tag_line.md)
  : Detect the presence of a properly structured tagline

- [`extract_all_tags()`](https://christian-million.github.io/qryflow/reference/extract_all_tags.md)
  [`extract_tag()`](https://christian-million.github.io/qryflow/reference/extract_all_tags.md)
  [`extract_name()`](https://christian-million.github.io/qryflow/reference/extract_all_tags.md)
  [`extract_type()`](https://christian-million.github.io/qryflow/reference/extract_all_tags.md)
  [`subset_tags()`](https://christian-million.github.io/qryflow/reference/extract_all_tags.md)
  : Extract tagged metadata from a SQL chunk

- [`new_qryflow_chunk()`](https://christian-million.github.io/qryflow/reference/new_qryflow_chunk.md)
  :

  Create an instance of the `qryflow_chunk` class

- [`qryflow_default_type()`](https://christian-million.github.io/qryflow/reference/qryflow_default_type.md)
  : Access the default qryflow chunk type

## Example Utilities

These functions help to quickly prepare the environment to demonstrate
qryflow functionality. Used in the examples, vignettes, and in the
testing suite.

- [`example_db_connect()`](https://christian-million.github.io/qryflow/reference/example_db_connect.md)
  : Create an example in-memory database
- [`example_sql_path()`](https://christian-million.github.io/qryflow/reference/example_sql_path.md)
  : Get path to qryflow example SQL scripts

# Articles

### All vignettes

- [Advanced Usage with
  qryflow](https://christian-million.github.io/qryflow/articles/advanced-qryflow.md):
- [Extending qryflow
  Functionality](https://christian-million.github.io/qryflow/articles/extend-qryflow.md):
- [Getting Started with
  qryflow](https://christian-million.github.io/qryflow/articles/qryflow.md):
